pico-8 cartridge // http://www.pico-8.com
version 29
__lua__

-- a game object should always have an update and draw function
game_objects = {}

-- @todo have an end state
-- @todo move all wait checking functionality inside the game state
game_state = {
  is_player_turn = true,
  wait = 0,
  wait_time = 30,
  switch_turns = function(self)
    self.is_player_turn = not self.is_player_turn
    self.wait = 0
  end,
  update = function(self)
    if (not self.is_player_turn) then
      self.wait += 1
    end
  end,
  draw = function(self)
    print(self.wait, 10, 5, 2)
    if (not self.is_player_turn and self.wait > 0 and self.wait <= self.wait_time) then
      print("enemy is attacking", 30, 43, 2)
    end

    if (self.is_player_turn) then
      print("press z to attack", 30, 43, 2)
    end
  end
}

-- @todo change these to be more themed towards candies
elements = {
  -- this a neutral type that applies no weaknesses or resistances
  normal = "normal",
  grass = "grass"
}

-- attacks
punch = {
  name = "punch",
  power = 25,
  element = elements.normal,
  status_effect = nil
}

kick = {
  name = "kick",
  power = 20,
  element = elements.normal,
  status_effect = nil
}

rot_teeth = {
  name = "rot teeth",
  power = 25,
  element = elements.normal,
  status_effect = nil
}

-- @todo this should raise defense
caramelize = {
  name = "caramelize",
  power = 0,
  element = elements.normal,
  status_effect = nil
}

-- unique candies
razor_apple = {
  name = "razor apple",
  sprite = nil,
  hp = 100,
  attack = 100,
  defense = 100,
  element = elements.grass,
  attacks = {
    punch,
    kick,
    rot_teeth,
    caramelize
  }
}

-- @todo create another candy and display the name in the draw function
function make_candy(candy, x, y, color, is_player)
  return {
    is_player = is_player,
    x = x,
    y = y,
    width = 16,
    height = 16,
    name = candy.name,
    sprite = candy.sprite,
    hp = candy.hp,
    attack = candy.attack,
    defense = candy.defense,
    element = candy.element,
    attacks = candy.attacks,
    state = nil, -- maybe to be used for status effects?
    update = function(self)
      -- when you attack, damage the enemy
      if (self.is_player and game_state.is_player_turn and btnp(4)) then
        self:selected_attack(enemy)
        game_state:switch_turns()
      end

      -- if it's not the player's turn and it's not the player
      -- self.wait x frames, and attack, then pass the turn
      if (not self.is_player) then
        if (game_state.wait > game_state.wait_time) then
          self:random_attack(player)
          game_state:switch_turns()
        end
      end
    end,
    random_attack = function(self, victim)
      local random_attack = self.attacks[flr(rnd(4)) + 1]
      self:attack(victim, random_attack.power)
    end,
    selected_attack = function(self, victim)
      -- @todo get the selected attack once menu is in place
      local selected_attack = self.attacks[1]
      self:attack(victim, selected_attack.power)
    end,
    attack = function(self, victim, power)
      victim.hp -= power
      if (victim.hp < 0) victim.hp = 0
    end,
    draw = function(self)
      -- draw character
      rectfill(
        self.x,
        self.y,
        self.x + self.width,
        self.y + self.height,
        color
      )

      -- draw hp (we may move this to a ui object later)
      print("hp " .. self.hp, self.x, self.y - 8, color)
    end
  }
end

function _init()
  add(game_objects, game_state)
  player = add(game_objects, make_candy(razor_apple, 10, 70, 8, true))
  enemy = add(game_objects, make_candy(razor_apple, 100, 13, 9, false))
end

function _update()
  for k, game_object in pairs(game_objects) do
    game_object:update()
  end
end

function _draw()
  cls()
  map()
  for k, game_object in pairs(game_objects) do
    game_object:draw()
  end

  -- @todo move this draw method to a ui/menu object
  local attack_display_y = 97
  for k, attack in pairs(player.attacks) do
    -- @todo we'll need to dynamically change the text color
    -- based on what the cursor is highlighting
    local attack_color = k == 1 and 12 or 7
    print(attack.name, 80, attack_display_y, attack_color)
    attack_display_y += 7
  end

  spr(15, 70, 96)
  print("razor apple is", 5, 97, 7)
  print("angry!!", 5, 104, 7)
end

__gfx__
0000000000cccccccccccc00c60000000000006cc60000000000006ccccccccc00000000c6000000000000000000006c000000000006c6000006c60000000000
000000000c666666666666c0c60000000000006cc60000000000006c6666666600000000c6000000000000000000006c000000000006c6000006c60000000700
00700700c66000000000066cc60000000000006cc60000000000006c0000000000000000c6000000000000000000006c000000000006c6000006c60000000c70
00077000c60000000000006cc60000000000006cc60000000000006c0000000000000000c6066666666666666666606c666666660006c6000006c60000000cc7
00077000c60000000000006cc60000000000006cc60000000000006c0000000000000000c66cccccccccccccccccc66ccccccccc0006c6000006c60000000cc0
00700700c60000000000006cc66000000000066cc60000000000006c0000000000000000ccc666666666666666666ccc6666c6660006c6000006c60000000c00
00000000c60000000000006c0c666666666666c0c60000000000006c0000000066666666c6600000000000000000066c0006c6000006c6006666c66600000000
00000000c60000000000006c00cccccccccccc00c60000000000006c00000000ccccccccc6000000000000000000006c0006c6000006c600cccccccc00000000
__map__
0107070707070707070707070707070200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0500000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0500000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0500000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0500000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0500000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0500000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0500000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0500000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0500000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0500000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
090a0a0a0a0a0a0a0c0a0a0a0a0a0a0b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05000000000000000d0000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05000000000000000d0000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05000000000000000d0000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
03080808080808080e0808080808080400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
